# å½“å‰ç‰ˆæœ¬ ï¼š python3.7.11
# å¼€å‘æ—¶é—´ ï¼š 2021/9/26 16:06
"""
å®é™…åº”ç”¨ä¸­ï¼Œæ ·æœ¬ä»¥åŠæ ·æœ¬æ ‡ç­¾çš„å­˜å‚¨æ–¹å¼å¯èƒ½å„ä¸ç›¸åŒï¼Œå¦‚æœ‰äº›åœºåˆæ‰€æœ‰çš„å›¾ç‰‡å­˜å‚¨åœ¨åŒä¸€ç›®å½•ä¸‹ï¼Œç±»åˆ«åå¯ä»å›¾ç‰‡åå­—ä¸­æ¨å¯¼å‡ºï¼Œ
ä¾‹å¦‚æ–‡ä»¶åä¸ºâ€œpikachu_asxes0132.pngâ€çš„å›¾ç‰‡ï¼Œå…¶ç±»åˆ«ä¿¡æ¯å¯ä»æ–‡ä»¶å pikachu æå–å‡ºã€‚æœ‰äº›æ•°æ®é›†æ ·æœ¬çš„æ ‡ç­¾ä¿¡æ¯ä¿å­˜ä¸º JSON æ ¼å¼çš„æ–‡æœ¬æ–‡ä»¶ä¸­ï¼Œ
éœ€è¦æŒ‰ç…§ JSON æ ¼å¼æŸ¥è¯¢æ¯ä¸ªæ ·æœ¬çš„æ ‡ç­¾ã€‚ä¸ç®¡æ•°æ®é›†æ˜¯ä»¥ä»€ä¹ˆæ–¹å¼å­˜å‚¨çš„ï¼Œæˆ‘ä»¬æ€»æ˜¯èƒ½å¤Ÿç”¨è¿‡é€»è¾‘è§„åˆ™è·å–æ‰€æœ‰æ ·æœ¬çš„è·¯å¾„å’Œæ ‡ç­¾ä¿¡æ¯ã€‚

æˆ‘ä»¬å°†è‡ªå®šä¹‰æ•°æ®çš„åŠ è½½æµç¨‹æŠ½è±¡ä¸ºå¦‚ä¸‹æ­¥éª¤ã€‚

15.2.1åˆ›å»ºç¼–ç è¡¨
æ ·æœ¬çš„ç±»åˆ«ä¸€èˆ¬ä»¥å­—ç¬¦ä¸²ç±»å‹çš„ç±»åˆ«åæ ‡è®°ï¼Œä½†æ˜¯å¯¹äºç¥ç»ç½‘ç»œæ¥è¯´ï¼Œé¦–å…ˆéœ€è¦å°†ç±»åˆ«åè¿›è¡Œæ•°å­—ç¼–ç ï¼Œç„¶ååœ¨åˆé€‚çš„æ—¶å€™å†è½¬æ¢æˆ One-hot ç¼–ç æˆ–å…¶ä»–ç¼–ç æ ¼å¼ã€‚
è€ƒè™‘ğ‘›ä¸ªç±» åˆ«çš„æ•°æ®é›†ï¼Œæˆ‘ä»¬å°†æ¯ä¸ªç±»åˆ«éšæœºç¼–ç ä¸ºğ‘™ âˆˆ [0, ğ‘› âˆ’ 1]çš„æ•°å­—ï¼Œç±»åˆ«åä¸æ•°å­—çš„æ˜ å°„å…³ç³»ç§°ä¸ºç¼–ç è¡¨ï¼Œä¸€æ—¦åˆ›å»ºåï¼Œä¸€èˆ¬ä¸èƒ½å˜åŠ¨ã€‚

é’ˆå¯¹ç²¾çµå®å¯æ¢¦æ•°æ®é›†çš„å­˜å‚¨æ ¼å¼ï¼Œæˆ‘ä»¬é€šè¿‡å¦‚ä¸‹æ–¹å¼åˆ›å»ºç¼–ç è¡¨ã€‚é¦–å…ˆæŒ‰åºéå†pokemon æ ¹ç›®å½•ä¸‹çš„æ‰€æœ‰å­ç›®å½•ï¼Œå¯¹æ¯ä¸ªå­ç›®æ ‡ï¼Œ
åˆ©ç”¨ç±»åˆ«åä½œä¸ºç¼–ç è¡¨å­—å…¸å¯¹è±¡name2label çš„é”®ï¼Œç¼–ç è¡¨çš„ç°æœ‰é”®å€¼å¯¹æ•°é‡ä½œä¸ºç±»åˆ«çš„æ ‡ç­¾æ˜ å°„æ•°å­—ï¼Œå¹¶ä¿å­˜è¿›name2label å­—å…¸å¯¹è±¡ã€‚
å®ç°å¦‚ä¸‹ï¼š
def load_pokemon(root, mode='train'):
    # åˆ›å»ºæ•°å­—ç¼–ç è¡¨
    name2label = {} # ç¼–ç è¡¨å­—å…¸ï¼Œ"sq...":0
    # éå†æ ¹ç›®å½•ä¸‹çš„å­æ–‡ä»¶å¤¹ï¼Œå¹¶æ’åºï¼Œä¿è¯æ˜ å°„å…³ç³»å›ºå®š
    for name in sorted(os.listdir(os.path.join(root))):
        # è·³è¿‡éæ–‡ä»¶å¤¹å¯¹è±¡
        if not os.path.isdir(os.path.join(root, name)):
            continue
        # ç»™æ¯ä¸ªç±»åˆ«ç¼–ç ä¸€ä¸ªæ•°å­—
        name2label[name] = len(name2label.keys())
         â€¦

15.2.2åˆ›å»ºæ ·æœ¬å’Œæ ‡ç­¾è¡¨æ ¼
ç¼–ç è¡¨ç¡®å®šåï¼Œæˆ‘ä»¬éœ€è¦æ ¹æ®å®é™…æ•°æ®çš„å­˜å‚¨æ–¹å¼è·å¾—æ¯ä¸ªæ ·æœ¬çš„å­˜å‚¨è·¯å¾„ä»¥åŠå®ƒçš„æ ‡ç­¾æ•°å­—ï¼Œåˆ†åˆ«è¡¨ç¤ºä¸º images å’Œ labels ä¸¤ä¸ª List å¯¹è±¡ã€‚
å…¶ä¸­ images List å­˜å‚¨äº†æ¯ä¸ªæ ·æœ¬çš„è·¯å¾„å­—ç¬¦ä¸²ï¼Œlabels List å­˜å‚¨äº†æ ·æœ¬çš„ç±»åˆ«æ•°å­—ï¼Œä¸¤è€…é•¿åº¦ä¸€è‡´ï¼Œä¸”å¯¹åº”ä½ç½®çš„å…ƒç´ ç›¸äº’å…³è”ã€‚

æˆ‘ä»¬å°† images å’Œ labels ä¿¡æ¯å­˜å‚¨åœ¨ csv æ ¼å¼çš„æ–‡ä»¶ä¸­ï¼Œå…¶ä¸­ csv æ–‡ä»¶æ ¼å¼æ˜¯ä¸€ç§ä»¥é€—å·ç¬¦å·åˆ†éš”æ•°æ®çš„çº¯æ–‡æœ¬æ–‡ä»¶æ ¼å¼ï¼Œå¯ä»¥ä½¿ç”¨è®°äº‹æœ¬æˆ–è€… MS Excel è½¯ä»¶æ‰“å¼€ã€‚
é€šè¿‡å°†æ‰€æœ‰æ ·æœ¬ä¿¡æ¯å­˜å‚¨åœ¨ä¸€ä¸ª csv æ–‡ä»¶ä¸­æœ‰è¯¸å¤šå¥½å¤„ï¼Œæ¯”å¦‚å¯ä»¥ç›´æ¥è¿›è¡Œæ•°æ®é›†çš„åˆ’åˆ†ï¼Œå¯ä»¥éšæœºé‡‡æ · Batch ç­‰ã€‚csv æ–‡ä»¶ä¸­å¯ä»¥ä¿å­˜æ•°æ®é›†æ‰€æœ‰æ ·æœ¬çš„ä¿¡æ¯ï¼Œ
ä¹Ÿå¯ä»¥æ ¹æ®è®­ç»ƒé›†ã€éªŒè¯é›†å’Œæµ‹è¯•é›†åˆ†åˆ«åˆ›å»º 3 ä¸ª csv æ–‡ä»¶ã€‚æœ€ç»ˆäº§ç”Ÿçš„ csv æ–‡ä»¶å†…å®¹å¦‚å›¾ 15.3 æ‰€ç¤ºï¼Œæ¯è¡Œçš„ç¬¬ä¸€ä¸ªå…ƒç´ ä¿å­˜äº†å½“å‰æ ·æœ¬çš„å­˜å‚¨è·¯å¾„ï¼Œ
ç¬¬äºŒä¸ªå…ƒç´ ä¿å­˜äº†æ ·æœ¬çš„ç±»åˆ«æ•°å­—ã€‚

csv æ–‡ä»¶åˆ›å»ºè¿‡ç¨‹ä¸ºï¼šéå† pokemon æ ¹ç›®å½•ä¸‹çš„æ‰€æœ‰å›¾ç‰‡ï¼Œè®°å½•å›¾ç‰‡çš„è·¯å¾„ï¼Œå¹¶æ ¹æ®ç¼–ç è¡¨è·å¾—å…¶ç¼–ç æ•°å­—ï¼Œä½œä¸ºä¸€è¡Œå†™å…¥åˆ° csv æ–‡ä»¶ä¸­ï¼Œ
ä»£ç å¦‚ä¸‹ï¼š
def load_csv(root, filename, name2label):
    # ä» csv æ–‡ä»¶è¿”å› images,labels åˆ—è¡¨
    # root:æ•°æ®é›†æ ¹ç›®å½•ï¼Œfilename:csv æ–‡ä»¶åï¼Œ name2label:ç±»åˆ«åç¼–ç è¡¨
    if not os.path.exists(os.path.join(root, filename)):
        # å¦‚æœ csv æ–‡ä»¶ä¸å­˜åœ¨ï¼Œåˆ™åˆ›å»º
        images = []
        for name in name2label.keys(): # éå†æ‰€æœ‰å­ç›®å½•ï¼Œè·å¾—æ‰€æœ‰çš„å›¾ç‰‡
            # åªè€ƒè™‘åç¼€ä¸º png,jpg,jpeg çš„å›¾ç‰‡ï¼š'pokemon\\mewtwo\\00001.png
            images += glob.glob(os.path.join(root, name, '*.png'))
            images += glob.glob(os.path.join(root, name, '*.jpg'))
            images += glob.glob(os.path.join(root, name, '*.jpeg'))
        # æ‰“å°æ•°æ®é›†ä¿¡æ¯ï¼š1167, 'pokemon\\bulbasaur\\00000000.png'
        print(len(images), images)
        random.shuffle(images) # éšæœºæ‰“æ•£é¡ºåº

        # åˆ›å»º csv æ–‡ä»¶ï¼Œå¹¶å­˜å‚¨å›¾ç‰‡è·¯å¾„åŠå…¶ label ä¿¡æ¯
        with open(os.path.join(root, filename), mode='w', newline='') as f:
            writer = csv.writer(f)
            for img in images:  # 'pokemon\\bulbasaur\\00000000.png'
                name = img.split(os.sep)[-2]
                label = name2label[name]
                # 'pokemon\\bulbasaur\\00000000.png', 0
                writer.writerow([img, label])
            print('written into csv file:', filename)
            ....
åˆ›å»ºå®Œ csv æ–‡ä»¶åï¼Œä¸‹ä¸€æ¬¡åªéœ€è¦ä» csv æ–‡ä»¶ä¸­è¯»å–æ ·æœ¬è·¯å¾„å’Œæ ‡ç­¾ä¿¡æ¯å³å¯ï¼Œè€Œä¸éœ€è¦æ¯æ¬¡éƒ½ç”Ÿæˆ csv æ–‡ä»¶ï¼Œæé«˜è®¡ç®—æ•ˆç‡ï¼Œ
ä»£ç å¦‚ä¸‹ï¼š
def load_csv(root, filename, name2label):
    â€¦
    # æ­¤æ—¶å·²ç»æœ‰ csv æ–‡ä»¶åœ¨æ–‡ä»¶ç³»ç»Ÿä¸Šï¼Œç›´æ¥è¯»å–
    images, labels = [], []
    with open(os.path.join(root, filename)) as f:
        reader = csv.reader(f)
        for row in reader:
            # 'pokemon\\bulbasaur\\00000000.png', 0
            img, label = row
            label = int(label)
            images.append(img)
            labels.append(label)

    # è¿”å›å›¾ç‰‡è·¯å¾„ list å’Œæ ‡ç­¾ list
    return images, labels


15.2.3æ•°æ®é›†åˆ’åˆ†
æ•°æ®é›†çš„åˆ’åˆ†éœ€è¦æ ¹æ®å®é™…æƒ…å†µæ¥çµæ´»è°ƒæ•´åˆ’åˆ†æ¯”ç‡ã€‚å½“æ•°æ®é›†æ ·æœ¬æ•°è¾ƒå¤šæ—¶ï¼Œå¯ä»¥é€‰æ‹© 80%-10%-10%çš„æ¯”ä¾‹åˆ†é…ç»™è®­ç»ƒé›†ã€éªŒè¯é›†å’Œæµ‹è¯•é›†ï¼›
å½“æ ·æœ¬æ•°é‡è¾ƒå°‘æ—¶ï¼Œå¦‚è¿™é‡Œçš„å®å¯æ¢¦æ•°æ®é›†å›¾ç‰‡æ€»æ•°ä»… 1000 å¼ å·¦å³ï¼Œå¦‚æœéªŒè¯é›†å’Œæµ‹è¯•é›†æ¯”ä¾‹åªæœ‰ 10%ï¼Œåˆ™å…¶å›¾ç‰‡æ•°é‡çº¦ä¸º 100 å¼ ï¼Œå› æ­¤éªŒè¯å‡†ç¡®ç‡å’Œæµ‹è¯•å‡†ç¡®ç‡å¯èƒ½æ³¢åŠ¨è¾ƒå¤§ã€‚
å¯¹äºå°å‹çš„æ•°æ®é›†ï¼Œå°½ç®¡æ ·æœ¬æ•°é‡è¾ƒå°ï¼Œä½†è¿˜æ˜¯éœ€è¦é€‚å½“å¢åŠ éªŒè¯é›†å’Œæµ‹è¯•é›†çš„æ¯”ä¾‹ï¼Œä»¥ä¿è¯è·å¾—å‡†ç¡®çš„æµ‹è¯•ç»“æœã€‚
è¿™é‡Œæˆ‘ä»¬å°†éªŒè¯é›†å’Œæµ‹è¯•é›†æ¯”ä¾‹å‡è®¾ç½®ä¸º 20%ï¼Œå³æœ‰çº¦ 200 å¼ å›¾ç‰‡ç”¨ä½œéªŒè¯å’Œæµ‹è¯•ã€‚

é¦–å…ˆè°ƒç”¨ load_csv å‡½æ•°åŠ è½½ images å’Œ labels åˆ—è¡¨ï¼Œæ ¹æ®å½“å‰æ¨¡å¼å‚æ•° mode åŠ è½½å¯¹åº”éƒ¨åˆ†çš„å›¾ç‰‡å’Œæ ‡ç­¾ã€‚å…·ä½“åœ°ï¼Œå¦‚æœæ¨¡å¼å‚æ•°ä¸º trainï¼Œ
åˆ™åˆ†åˆ«å– images å’Œ labels çš„å‰ 60%æ•°æ®ä½œä¸ºè®­ç»ƒé›†ï¼›å¦‚æœæ¨¡å¼å‚æ•°ä¸º valï¼Œåˆ™åˆ†åˆ«å– images å’Œ labels çš„ 60%åˆ° 80%åŒºåŸŸæ•°æ®ä½œä¸ºéªŒè¯é›†ï¼›
å¦‚æœæ¨¡å¼å‚æ•°ä¸º testï¼Œåˆ™åˆ†åˆ«å– images å’Œ labels çš„å 20%ä½œä¸ºæµ‹è¯•é›†ã€‚
ä»£ç å®ç°å¦‚ä¸‹ï¼š
def load_pokemon(root, mode='train'):
    â€¦
    # è¯»å– Label ä¿¡æ¯
    # [file1,file2,], [3,1]
    images, labels = load_csv(root, 'images.csv', name2label)
    # æ•°æ®é›†åˆ’åˆ†
    if mode == 'train':  # 60%
        images = images[:int(0.6 * len(images))]
        labels = labels[:int(0.6 * len(labels))]
    elif mode == 'val': # 20% = 60%->80%
        images = images[int(0.6 * len(images)):int(0.8 * len(images))]
        labels = labels[int(0.6 * len(labels)):int(0.8 * len(labels))]
    else: # 20% = 80%->100%
        images = images[int(0.8 * len(images)):]
        labels = labels[int(0.8 * len(labels)):]

    return images, labels, name2label
éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œæ¯æ¬¡è¿è¡Œæ—¶çš„æ•°æ®é›†åˆ’åˆ†æ–¹æ¡ˆéœ€å›ºå®šï¼Œé˜²æ­¢ä½¿ç”¨æµ‹è¯•é›†çš„æ ·æœ¬è®­ç»ƒï¼Œå¯¼è‡´æ¨¡å‹æ³›åŒ–æ€§èƒ½ä¸å‡†ç¡®ã€‚
"""