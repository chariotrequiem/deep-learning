# å½“å‰ç‰ˆæœ¬ ï¼š python3.7.11
# å¼€å‘æ—¶é—´ ï¼š 2021/9/24 22:06
"""
è‡ªç¼–ç å™¨ç®—æ³•åŸç†éå¸¸ç®€å•ï¼Œå®ç°æ–¹ä¾¿ï¼Œè®­ç»ƒä¹Ÿè¾ƒç¨³å®šï¼Œç›¸å¯¹äº PCA ç®—æ³•ï¼Œç¥ç»ç½‘ç»œçš„å¼ºå¤§è¡¨è¾¾èƒ½åŠ›å¯ä»¥å­¦ä¹ åˆ°è¾“å…¥çš„é«˜å±‚æŠ½è±¡çš„éšè—ç‰¹å¾å‘é‡ğ’›ï¼Œ
åŒæ—¶ä¹Ÿèƒ½å¤ŸåŸºäºğ’›é‡å»ºå‡ºè¾“å…¥ã€‚è¿™é‡Œæˆ‘ä»¬åŸºäº Fashsion MNIST æ•°æ®é›†è¿›è¡Œå›¾ç‰‡é‡å»ºå®æˆ˜ã€‚

12.2.1Fashion MNISTæ•°æ®é›†
Fashion MNIST æ˜¯ä¸€ä¸ªå®šä½åœ¨æ¯” MNIST å›¾ç‰‡è¯†åˆ«é—®é¢˜ç¨å¤æ‚çš„æ•°æ®é›†ï¼Œå®ƒçš„è®¾å®šä¸MNIST å‡ ä¹å®Œå…¨ä¸€æ ·ï¼ŒåŒ…å«äº† 10 ç±»ä¸åŒç±»å‹çš„è¡£æœã€é‹å­ã€åŒ…ç­‰ç°åº¦å›¾ç‰‡ï¼Œ
å›¾ç‰‡å¤§å°ä¸º28 Ã— 28ï¼Œå…± 70000 å¼ å›¾ç‰‡ï¼Œå…¶ä¸­ 60000 å¼ ç”¨äºè®­ç»ƒé›†ï¼Œ10000 å¼ ç”¨äºæµ‹è¯•é›†ï¼Œå¦‚å›¾ 12.4æ‰€ç¤ºï¼Œæ¯è¡Œæ˜¯ä¸€ç§ç±»åˆ«å›¾ç‰‡ã€‚
å¯ä»¥çœ‹åˆ°ï¼ŒFashion MNIST é™¤äº†å›¾ç‰‡å†…å®¹ä¸ MNIST ä¸ä¸€æ ·ï¼Œå…¶å®ƒè®¾å®šéƒ½ç›¸åŒï¼Œå¤§éƒ¨åˆ†æƒ…å†µå¯ä»¥ç›´æ¥æ›¿æ¢æ‰åŸæ¥åŸºäº MNIST è®­ç»ƒçš„ç®—æ³•ä»£ç ï¼Œ
è€Œä¸éœ€è¦é¢å¤–ä¿®æ”¹ã€‚ç”±äº Fashion MNIST å›¾ç‰‡è¯†åˆ«ç›¸å¯¹äº MNIST å›¾ç‰‡æ›´éš¾ï¼Œå› æ­¤å¯ä»¥ç”¨äºæµ‹è¯•ç¨å¤æ‚çš„ç®—æ³•æ€§èƒ½ã€‚

åœ¨ TensorFlow ä¸­ï¼ŒåŠ è½½ Fashion MNIST æ•°æ®é›†åŒæ ·éå¸¸æ–¹ä¾¿ï¼Œåˆ©ç”¨keras.datasets.fashion_mnist.load_data()å‡½æ•°å³å¯åœ¨çº¿ä¸‹è½½ã€ç®¡ç†å’ŒåŠ è½½ã€‚
ä»£ç å¦‚ä¸‹ï¼š
# åŠ è½½ Fashion MNIST å›¾ç‰‡æ•°æ®é›†
(x_train, y_train), (x_test, y_test) = keras.datasets.fashion_mnist.load_data()
# å½’ä¸€åŒ–
x_train, x_test = x_train.astype(np.float32) / 255., x_test.astype(np.float32) / 255.
# åªéœ€è¦é€šè¿‡å›¾ç‰‡æ•°æ®å³å¯æ„å»ºæ•°æ®é›†å¯¹è±¡ï¼Œä¸éœ€è¦æ ‡ç­¾
train_db = tf.data.Dataset.from_tensor_slices(x_train)
train_db = train_db.shuffle(batchsz * 5).batch(batchsz)
# æ„å»ºæµ‹è¯•é›†å¯¹è±¡
test_db = tf.data.Dataset.from_tensor_slices(x_test)
test_db = test_db.batch(batchsz)


12.2.2ç¼–ç å™¨
æˆ‘ä»¬åˆ©ç”¨ç¼–ç å™¨å°†è¾“å…¥å›¾ç‰‡ğ’™ âˆˆ ğ‘…784é™ç»´åˆ°è¾ƒä½ç»´åº¦çš„éšè—å‘é‡ï¼šhâˆˆ ğ‘…20ï¼Œå¹¶åŸºäºéšè—å‘é‡håˆ©ç”¨è§£ç å™¨é‡å»ºå›¾ç‰‡ï¼Œè‡ªç¼–ç å™¨æ¨¡å‹å¦‚å›¾ 12.5 æ‰€ç¤ºï¼Œ
ç¼–ç å™¨ç”± 3 å±‚å…¨è¿æ¥å±‚ç½‘ç»œç»„æˆï¼Œè¾“å‡ºèŠ‚ç‚¹æ•°åˆ†åˆ«ä¸º 256ã€128ã€20ï¼Œè§£ç å™¨åŒæ ·ç”± 3 å±‚å…¨è¿æ¥ç½‘ç»œç»„æˆï¼Œè¾“å‡ºèŠ‚ç‚¹æ•°åˆ†åˆ«ä¸º 128ã€256ã€784ã€‚

é¦–å…ˆæ˜¯ç¼–ç å™¨å­ç½‘ç»œçš„å®ç°ã€‚åˆ©ç”¨ 3 å±‚çš„ç¥ç»ç½‘ç»œå°†é•¿åº¦ä¸º 784 çš„å›¾ç‰‡å‘é‡æ•°æ®ä¾æ¬¡é™ç»´åˆ° 256ã€128ï¼Œæœ€åé™ç»´åˆ° h_dim ç»´åº¦ï¼Œ
æ¯å±‚ä½¿ç”¨ ReLU æ¿€æ´»å‡½æ•°ï¼Œæœ€åä¸€å±‚ä¸ä½¿ç”¨æ¿€æ´»å‡½æ•°ã€‚ä»£ç å¦‚ä¸‹ï¼š

# åˆ›å»º Encoders ç½‘ç»œï¼Œå®ç°åœ¨è‡ªç¼–ç å™¨ç±»çš„åˆå§‹åŒ–å‡½æ•°ä¸­
self.encoder = Sequential([
    layers.Dense(256, activation=tf.nn.relu),
    layers.Dense(128, activation=tf.nn.relu),
    layers.Dense(h_dim)
])


12.2.3è§£ç å™¨
ç„¶åå†æ¥åˆ›å»ºè§£ç å™¨å­ç½‘ç»œï¼Œè¿™é‡ŒåŸºäºéšè—å‘é‡ h_dim ä¾æ¬¡å‡ç»´åˆ° 128ã€256ã€784 é•¿ åº¦ï¼Œé™¤æœ€åä¸€å±‚ï¼Œæ¿€æ´»å‡½æ•°ä½¿ç”¨ ReLU å‡½æ•°ã€‚
è§£ç å™¨çš„è¾“å‡ºä¸º 784 é•¿åº¦çš„å‘é‡ï¼Œä»£è¡¨äº†æ‰“å¹³åçš„28 Ã— 28å¤§å°å›¾ç‰‡ï¼Œé€šè¿‡ Reshape æ“ä½œå³å¯æ¢å¤ä¸ºå›¾ç‰‡çŸ©é˜µã€‚
ä»£ç å¦‚ä¸‹ï¼š
# åˆ›å»º Decoders ç½‘ç»œ
self.decoder = Sequential([
    layers.Dense(128, activation=tf.nn.relu),
    layers.Dense(256, activation=tf.nn.relu),
    layers.Dense(784)
])


12.2.4è‡ªç¼–ç å™¨
ä¸Šè¿°çš„ç¼–ç å™¨å’Œè§£ç å™¨ 2 ä¸ªå­ç½‘ç»œå‡å®ç°åœ¨è‡ªç¼–ç å™¨ç±» AE ä¸­ï¼Œæˆ‘ä»¬åœ¨åˆå§‹åŒ–å‡½æ•°ä¸­
åŒæ—¶åˆ›å»ºè¿™ä¸¤ä¸ªå­ç½‘ç»œã€‚ä»£ç å¦‚ä¸‹ï¼š
class AE(keras.Model):
    # è‡ªç¼–ç å™¨æ¨¡å‹ç±»ï¼ŒåŒ…å«äº† Encoder å’Œ Decoder2 ä¸ªå­ç½‘ç»œ
    def __init__(self):
        super(AE, self).__init__()
        # åˆ›å»º Encoders ç½‘ç»œ
        self.encoder = Sequential([
            layers.Dense(256, activation=tf.nn.relu),
            layers.Dense(128, activation=tf.nn.relu),
            layers.Dense(h_dim)
        ])
        # åˆ›å»º Decoders ç½‘ç»œ
            self.decoder = Sequential([
            layers.Dense(128, activation=tf.nn.relu),
            layers.Dense(256, activation=tf.nn.relu),
            layers.Dense(784)
        ])
æ¥ä¸‹æ¥å°†å‰å‘ä¼ æ’­è¿‡ç¨‹å®ç°åœ¨ call å‡½æ•°ä¸­ï¼Œè¾“å…¥å›¾ç‰‡é¦–å…ˆé€šè¿‡ encoder å­ç½‘ç»œå¾—åˆ°éšè—å‘é‡ hï¼Œå†é€šè¿‡ decoder å¾—åˆ°é‡å»ºå›¾ç‰‡ã€‚
ä¾æ¬¡è°ƒç”¨ç¼–ç å™¨å’Œè§£ç å™¨çš„å‰å‘ä¼ æ’­å‡½æ•°å³å¯ï¼Œ
ä»£ç å¦‚ä¸‹ï¼š
    def call(self, inputs, training=None):
        # å‰å‘ä¼ æ’­å‡½æ•°
        # ç¼–ç è·å¾—éšè—å‘é‡ h,[b, 784] => [b, 20]
        h = self.encoder(inputs)
        # è§£ç è·å¾—é‡å»ºå›¾ç‰‡ï¼Œ[b, 20] => [b, 784]
        x_hat = self.decoder(h)
        return x_hat

12.2.5ç½‘ç»œè®­ç»ƒ
è‡ªç¼–ç å™¨çš„è®­ç»ƒè¿‡ç¨‹ä¸åˆ†ç±»å™¨çš„åŸºæœ¬ä¸€è‡´ï¼Œé€šè¿‡è¯¯å·®å‡½æ•°è®¡ç®—å‡ºé‡å»ºå‘é‡ğ’™ ä¸åŸå§‹è¾“å…¥å‘é‡ğ’™ä¹‹é—´çš„è·ç¦»ï¼Œ
å†åˆ©ç”¨ TensorFlow çš„è‡ªåŠ¨æ±‚å¯¼æœºåˆ¶åŒæ—¶æ±‚å‡º encoder å’Œ decoder çš„æ¢¯åº¦ï¼Œå¾ªç¯æ›´æ–°å³å¯ã€‚
é¦–å…ˆåˆ›å»ºè‡ªç¼–ç å™¨å®ä¾‹å’Œä¼˜åŒ–å™¨ï¼Œå¹¶è®¾ç½®åˆé€‚çš„å­¦ä¹ ç‡ã€‚
ä¾‹å¦‚ï¼š
# åˆ›å»ºç½‘ç»œå¯¹è±¡
model = AE()
# æŒ‡å®šè¾“å…¥å¤§å°
model.build(input_shape=(4, 784))
# æ‰“å°ç½‘ç»œä¿¡æ¯
model.summary()
# åˆ›å»ºä¼˜åŒ–å™¨ï¼Œå¹¶è®¾ç½®å­¦ä¹ ç‡
optimizer = optimizers.Adam(lr=lr)

è¿™é‡Œå›ºå®šè®­ç»ƒ 100 ä¸ª Epochï¼Œæ¯æ¬¡é€šè¿‡å‰å‘è®¡ç®—è·å¾—é‡å»ºå›¾ç‰‡å‘é‡ï¼Œå¹¶åˆ©ç”¨tf.nn.sigmoid_cross_entropy_with_logits æŸå¤±å‡½æ•°è®¡ç®—é‡å»ºå›¾ç‰‡ä¸åŸå§‹å›¾ç‰‡ç›´æ¥çš„è¯¯å·®ï¼Œ
å®é™…ä¸Šåˆ©ç”¨ MSE è¯¯å·®å‡½æ•°ä¹Ÿæ˜¯å¯è¡Œçš„ã€‚ä»£ç å¦‚ä¸‹ï¼š
for epoch in range(100): # è®­ç»ƒ 100 ä¸ª Epoch
    for step, x in enumerate(train_db): # éå†è®­ç»ƒé›†
        # æ‰“å¹³ï¼Œ[b, 28, 28] => [b, 784]
        x = tf.reshape(x, [-1, 784])
        # æ„å»ºæ¢¯åº¦è®°å½•å™¨
        with tf.GradientTape() as tape:
            # å‰å‘è®¡ç®—è·å¾—é‡å»ºçš„å›¾ç‰‡
            x_rec_logits = model(x)
            # è®¡ç®—é‡å»ºå›¾ç‰‡ä¸è¾“å…¥ä¹‹é—´çš„æŸå¤±å‡½æ•°
            rec_loss = tf.nn.sigmoid_cross_entropy_with_logits(labels=x, logits=x_rec_logits)
            # è®¡ç®—å‡å€¼
            rec_loss = tf.reduce_mean(rec_loss)

        # è‡ªåŠ¨æ±‚å¯¼ï¼ŒåŒ…å«äº† 2 ä¸ªå­ç½‘ç»œçš„æ¢¯åº¦
        grads = tape.gradient(rec_loss, model.trainable_variables)
        # è‡ªåŠ¨æ›´æ–°ï¼ŒåŒæ—¶æ›´æ–° 2 ä¸ªå­ç½‘ç»œ
        optimizer.apply_gradients(zip(grads, model.trainable_variables))

        if step % 100 ==0: # é—´éš”æ€§æ‰“å°è®­ç»ƒè¯¯å·®
            print(epoch, step, float(rec_loss))

12.2.6å›¾ç‰‡é‡å»º
ä¸åˆ†ç±»é—®é¢˜ä¸åŒçš„æ˜¯ï¼Œè‡ªç¼–ç å™¨çš„æ¨¡å‹æ€§èƒ½ä¸€èˆ¬ä¸å¥½é‡åŒ–è¯„ä»·ï¼Œå°½ç®¡â„’å€¼å¯ä»¥åœ¨ä¸€å®šç¨‹åº¦ä¸Šä»£è¡¨ç½‘ç»œçš„å­¦ä¹ æ•ˆæœï¼Œä½†æˆ‘ä»¬æœ€ç»ˆå¸Œæœ›è·å¾—è¿˜åŸåº¦è¾ƒé«˜ã€æ ·å¼è¾ƒä¸°å¯Œçš„é‡å»ºæ ·æœ¬ã€‚
å› æ­¤ä¸€èˆ¬éœ€è¦æ ¹æ®å…·ä½“é—®é¢˜æ¥è®¨è®ºè‡ªç¼–ç å™¨çš„å­¦ä¹ æ•ˆæœï¼Œæ¯”å¦‚å¯¹äºå›¾ç‰‡é‡å»ºï¼Œä¸€èˆ¬ä¾èµ–äºäººå·¥ä¸»è§‚è¯„ä»·å›¾ç‰‡ç”Ÿæˆçš„è´¨é‡ï¼Œ
æˆ–åˆ©ç”¨æŸäº›å›¾ç‰‡é€¼çœŸåº¦è®¡ç®—æ–¹æ³•(å¦‚ Inception Score å’Œ Frechet Inception Distance)æ¥è¾…åŠ©è¯„ä¼°ã€‚

ä¸ºäº†æµ‹è¯•å›¾ç‰‡é‡å»ºæ•ˆæœï¼Œæˆ‘ä»¬æŠŠæ•°æ®é›†åˆ‡åˆ†ä¸ºè®­ç»ƒé›†ä¸æµ‹è¯•é›†ï¼Œå…¶ä¸­æµ‹è¯•é›†ä¸å‚ä¸è®­ç»ƒã€‚æˆ‘ä»¬ä»æµ‹è¯•é›†ä¸­éšæœºé‡‡æ ·æµ‹è¯•å›¾ç‰‡ğ’™ âˆˆ ğ”»testï¼Œ
ç»è¿‡è‡ªç¼–ç å™¨è®¡ç®—å¾—åˆ°é‡å»ºåçš„å›¾ç‰‡ï¼Œç„¶åå°†çœŸå®å›¾ç‰‡ä¸é‡å»ºå›¾ç‰‡ä¿å­˜ä¸ºå›¾ç‰‡é˜µåˆ—ï¼Œå¹¶å¯è§†åŒ–ï¼Œæ–¹ä¾¿æ¯”å¯¹ã€‚
ä»£ç å¦‚ä¸‹ï¼š
        # é‡å»ºå›¾ç‰‡ï¼Œä»æµ‹è¯•é›†é‡‡æ ·ä¸€æ‰¹å›¾ç‰‡
        x = next(iter(test_db))
        logits = model(tf.reshape(x, [-1, 784])) # æ‰“å¹³å¹¶é€å…¥è‡ªç¼–ç å™¨
        x_hat = tf.sigmoid(logits) # å°†è¾“å‡ºè½¬æ¢ä¸ºåƒç´ å€¼ï¼Œä½¿ç”¨ sigmoid å‡½æ•°
        # æ¢å¤ä¸º 28x28,[b, 784] => [b, 28, 28]
        x_hat = tf.reshape(x_hat, [-1, 28, 28])
        # è¾“å…¥çš„å‰ 50 å¼ +é‡å»ºçš„å‰ 50 å¼ å›¾ç‰‡åˆå¹¶ï¼Œ[b, 28, 28] => [2b, 28, 28]
        x_concat = tf.concat([x[:50], x_hat[:50]], axis=0)
        x_concat = x_concat.numpy() * 255. # æ¢å¤ä¸º 0~255 èŒƒå›´
        x_concat = x_concat.astype(np.uint8) # è½¬æ¢ä¸ºæ•´å‹
        save_images(x_concat, 'ae_images/rec_epoch_%d.png'%epoch) # ä¿å­˜å›¾ç‰‡

å›¾ç‰‡é‡å»ºçš„æ•ˆæœå¦‚å›¾ 12.6ã€å›¾ 12.7ã€å›¾ 12.8 æ‰€ç¤ºï¼Œå…¶ä¸­æ¯å¼ å›¾ç‰‡çš„å·¦è¾¹ 5 åˆ—ä¸ºçœŸå®å›¾ç‰‡ï¼Œå³è¾¹ 5 åˆ—ä¸ºå¯¹åº”çš„é‡å»ºå›¾ç‰‡ã€‚
å¯ä»¥çœ‹åˆ°ï¼Œç¬¬ä¸€ä¸ª Epoch æ—¶ï¼Œå›¾ç‰‡é‡å»ºæ•ˆæœè¾ƒå·®ï¼Œå›¾ç‰‡éå¸¸æ¨¡ç³Šï¼Œé€¼çœŸåº¦è¾ƒå·®ï¼›éšç€è®­ç»ƒçš„è¿›è¡Œï¼Œé‡å»ºå›¾ç‰‡è¾¹ç¼˜è¶Šæ¥è¶Šæ¸…æ™°ï¼Œ
ç¬¬ 100 ä¸ª Epochæ—¶ï¼Œé‡å»ºçš„å›¾ç‰‡æ•ˆæœå·²ç»æ¯”è¾ƒæ¥è¿‘çœŸå®å›¾ç‰‡ã€‚

è¿™é‡Œçš„ save_images å‡½æ•°è´Ÿè´£å°†å¤šå¼ å›¾ç‰‡åˆå¹¶å¹¶ä¿å­˜ä¸ºä¸€å¼ å¤§å›¾ï¼Œè¿™éƒ¨åˆ†ä»£ç ä½¿ç”¨ PILå›¾ç‰‡åº“å®Œæˆå›¾ç‰‡é˜µåˆ—é€»è¾‘ï¼Œ
ä»£ç å¦‚ä¸‹ï¼š
def save_images(imgs, name):
    # åˆ›å»º 280x280 å¤§å°å›¾ç‰‡é˜µåˆ—
    new_im = Image.new('L', (280, 280))
    index = 0
    for i in range(0, 280, 28): # 10 è¡Œå›¾ç‰‡é˜µåˆ—
        for j in range(0, 280, 28): # 10 åˆ—å›¾ç‰‡é˜µåˆ—
            im = imgs[index]
            im = Image.fromarray(im, mode='L')
            new_im.paste(im, (i, j)) # å†™å…¥å¯¹åº”ä½ç½®
            index += 1 # ä¿å­˜å›¾ç‰‡é˜µåˆ—
    new_im.save(name)
"""