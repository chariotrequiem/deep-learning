# å½“å‰ç‰ˆæœ¬ ï¼š python3.7.11
# å¼€å‘æ—¶é—´ ï¼š 2021/9/23 9:53
"""
å·ç§¯ç¥ç»ç½‘ç»œçš„å‡ºç°ï¼Œç½‘ç»œå‚æ•°é‡å¤§å¤§å‡ä½ï¼Œä½¿å¾—å‡ åå±‚çš„æ·±å±‚ç½‘ç»œæˆä¸ºå¯èƒ½ã€‚ç„¶è€Œï¼Œåœ¨æ®‹å·®ç½‘ç»œå‡ºç°ä¹‹å‰ï¼Œç½‘ç»œçš„åŠ æ·±ä½¿å¾—ç½‘ç»œè®­ç»ƒå˜å¾—éå¸¸ä¸ç¨³å®šï¼Œ
ç”šè‡³å‡ºç°ç½‘ç»œé•¿æ—¶é—´ä¸æ›´æ–°ç”šè‡³ä¸æ”¶æ•›çš„ç°è±¡ï¼ŒåŒæ—¶ç½‘ç»œå¯¹è¶…å‚æ•°æ¯”è¾ƒæ•æ„Ÿï¼Œè¶…å‚æ•°çš„å¾®é‡æ‰°åŠ¨ä¹Ÿä¼šå¯¼è‡´ç½‘ç»œçš„è®­ç»ƒè½¨è¿¹å®Œå…¨æ”¹å˜ã€‚

2015 å¹´ï¼ŒGoogle ç ”ç©¶äººå‘˜ Sergey Ioffe ç­‰æå‡ºäº†ä¸€ç§å‚æ•°æ ‡å‡†åŒ–(Normalize)çš„æ‰‹æ®µï¼Œå¹¶åŸºäºå‚æ•°æ ‡å‡†åŒ–è®¾è®¡äº† Batch Nomalization(ç®€å†™ä¸º BatchNormï¼Œæˆ– BN)å±‚ [6]ã€‚
BN å±‚çš„æå‡ºï¼Œä½¿å¾—ç½‘ç»œçš„è¶…å‚æ•°çš„è®¾å®šæ›´åŠ è‡ªç”±ï¼Œæ¯”å¦‚æ›´å¤§çš„å­¦ä¹ ç‡ã€æ›´éšæ„çš„ç½‘ç»œåˆå§‹åŒ–ç­‰ï¼ŒåŒæ—¶ç½‘ç»œçš„æ”¶æ•›é€Ÿåº¦æ›´å¿«ï¼Œæ€§èƒ½ä¹Ÿæ›´å¥½ã€‚
BN å±‚æå‡ºåä¾¿å¹¿æ³›åœ°åº”ç”¨åœ¨å„ç§æ·±åº¦ç½‘ç»œæ¨¡å‹ä¸Šï¼Œå·ç§¯å±‚ã€BN å±‚ã€ReLU å±‚ã€æ± åŒ–å±‚ä¸€åº¦æˆä¸ºç½‘ç»œæ¨¡å‹çš„æ ‡é…å•å…ƒå—ï¼Œ
é€šè¿‡å †å  Conv-BN-ReLU-Pooling æ–¹å¼å¾€å¾€å¯ä»¥è·å¾—ä¸é”™çš„æ¨¡å‹æ€§èƒ½ã€‚

é¦–å…ˆæˆ‘ä»¬æ¥æ¢ç´¢ï¼Œä¸ºä»€ä¹ˆéœ€è¦å¯¹ç½‘ç»œä¸­çš„æ•°æ®è¿›è¡Œæ ‡å‡†åŒ–æ“ä½œï¼Ÿè¿™ä¸ªé—®é¢˜å¾ˆéš¾ä»ç†è®ºå±‚é¢è§£é‡Šé€å½»ï¼Œå³ä½¿æ˜¯ BN å±‚çš„ä½œè€…ç»™å‡ºçš„è§£é‡Šä¹Ÿæœªå¿…è®©æ‰€æœ‰äººä¿¡æœã€‚
ä¸å…¶çº ç»“å…¶ç¼˜ç”±ï¼Œä¸å¦‚é€šè¿‡å…·ä½“é—®é¢˜æ¥æ„Ÿå—æ•°æ®æ ‡å‡†åŒ–åçš„å¥½å¤„ã€‚

è€ƒè™‘ Sigmoid æ¿€æ´»å‡½æ•°å’Œå®ƒçš„æ¢¯åº¦åˆ†å¸ƒï¼Œå¦‚ä¸‹å›¾ 10.39 æ‰€ç¤ºï¼ŒSigmoid å‡½æ•°åœ¨ğ‘¥ âˆˆ [âˆ’2 2 ]åŒºé—´çš„å¯¼æ•°å€¼åœ¨ [0.1, 0.25]åŒºé—´åˆ†å¸ƒï¼›
å½“ğ‘¥ > 2 æˆ–ğ‘¥ < âˆ’2æ—¶ï¼ŒSigmoid å‡½æ•°çš„å¯¼æ•°å˜å¾—å¾ˆå°ï¼Œé€¼è¿‘äº 0ï¼Œä»è€Œå®¹æ˜“å‡ºç°æ¢¯åº¦å¼¥æ•£ç°è±¡ã€‚
ä¸ºäº†é¿å…å› ä¸ºè¾“å…¥è¾ƒå¤§æˆ–è€…è¾ƒå°è€Œå¯¼è‡´Sigmoid å‡½æ•°å‡ºç°æ¢¯åº¦å¼¥æ•£ç°è±¡ï¼Œå°†å‡½æ•°è¾“å…¥ğ‘¥æ ‡å‡†åŒ–æ˜ å°„åˆ° 0 é™„è¿‘çš„ä¸€æ®µè¾ƒå°åŒºé—´å°†å˜å¾—éå¸¸é‡è¦ï¼Œ
å¯ä»¥ä»å›¾ 10.39 çœ‹åˆ°ï¼Œé€šè¿‡æ ‡å‡†åŒ–é‡æ˜ å°„åï¼Œå€¼è¢«æ˜ å°„åœ¨ 0 é™„è¿‘ï¼Œæ­¤å¤„çš„å¯¼æ•°å€¼ä¸è‡³äºè¿‡å°ï¼Œä»è€Œä¸å®¹æ˜“å‡ºç°æ¢¯åº¦å¼¥æ•£ç°è±¡ã€‚
è¿™æ˜¯ä½¿ç”¨æ ‡å‡†åŒ–æ‰‹æ®µå—ç›Šçš„ä¸€ä¸ªä¾‹å­ã€‚

æˆ‘ä»¬å†çœ‹å¦ä¸€ä¸ªä¾‹å­ã€‚è€ƒè™‘ 2 ä¸ªè¾“å…¥èŠ‚ç‚¹çš„çº¿æ€§æ¨¡å‹ï¼Œå¦‚å›¾ 10.40(a)æ‰€ç¤ºï¼š
                            â„’ = ğ‘ = ğ‘¥1ğ‘¤1 + ğ‘¥2ğ‘¤2 + b
è®¨è®ºå¦‚ä¸‹ 2 ç§è¾“å…¥åˆ†å¸ƒä¸‹çš„ä¼˜åŒ–é—®é¢˜ï¼š
â‘ è¾“å…¥ğ‘¥1 âˆˆ [1, 10]ï¼Œğ‘¥2 âˆˆ [1, 10]
â‘ è¾“å…¥ğ‘¥1 âˆˆ [1, 10]ï¼Œğ‘¥2 âˆˆ [100, 1000]
ç”±äºæ¨¡å‹ç›¸å¯¹ç®€å•ï¼Œå¯ä»¥ç»˜åˆ¶å‡º 2 ç§ğ‘¥1ã€ğ‘¥2ä¸‹ï¼Œå‡½æ•°çš„æŸå¤±ç­‰é«˜çº¿å›¾ï¼Œå›¾ 10.40(b)æ˜¯ğ‘¥1 âˆˆ [1, 10]ã€ğ‘¥2 âˆˆ [100, 1000]æ—¶çš„æŸæ¡ä¼˜åŒ–è½¨è¿¹çº¿ç¤ºæ„ï¼Œ
å›¾ 10.40(c)æ˜¯ğ‘¥1 âˆˆ [1, 10]ã€ğ‘¥2 âˆˆ [1, 10]æ—¶çš„æŸæ¡ä¼˜åŒ–è½¨è¿¹çº¿ç¤ºæ„ï¼Œå›¾ä¸­çš„åœ†ç¯ä¸­å¿ƒå³ä¸ºå…¨å±€æå€¼ç‚¹.

è€ƒè™‘åˆ°
                    ğœ•â„’ / ğœ•ğ‘¤1 = ğ‘¥1
                    ğœ•â„’ / ğœ•ğ‘¤2 = ğ‘¥2
å½“ğ‘¥1ã€ğ‘¥2è¾“å…¥åˆ†å¸ƒç›¸è¿‘æ—¶ï¼Œğœ•â„’/ğœ•ğ‘¤1ã€ğœ•â„’/ğœ•ğ‘¤2åå¯¼æ•°å€¼ç›¸å½“ï¼Œå‡½æ•°çš„ä¼˜åŒ–è½¨è¿¹å¦‚å›¾ 10.40(c)æ‰€ç¤ºï¼›
å½“ğ‘¥1ã€ğ‘¥2è¾“å…¥åˆ†å¸ƒå·®è·è¾ƒå¤§æ—¶ï¼Œæ¯”å¦‚ğ‘¥1 â‰ª ğ‘¥2ï¼Œåˆ™
                            ğœ•â„’ / ğœ•ğ‘¤1 â‰ª ğœ•â„’ / ğœ•ğ‘¤2
æŸå¤±å‡½æ•°ç­‰åŠ¿çº¿åœ¨ğ‘¤2è½´æ›´åŠ é™¡å³­ï¼ŒæŸæ¡å¯èƒ½çš„ä¼˜åŒ–è½¨è¿¹å¦‚å›¾ 10.40(b)æ‰€ç¤ºã€‚å¯¹æ¯” 2 æ¡ä¼˜åŒ–è½¨è¿¹çº¿å¯ä»¥è§‚å¯Ÿåˆ°ï¼Œ
ğ‘¥1ã€ğ‘¥2åˆ†å¸ƒç›¸è¿‘æ—¶å›¾ 10.40(c)ä¸­æ”¶æ•›æ›´åŠ å¿«é€Ÿï¼Œä¼˜åŒ–è½¨è¿¹æ›´ç†æƒ³ã€‚

é€šè¿‡ä¸Šè¿°çš„ 2 ä¸ªä¾‹å­ï¼Œæˆ‘ä»¬èƒ½å¤Ÿç»éªŒæ€§å½’çº³å‡ºï¼šç½‘ç»œå±‚è¾“å…¥ğ‘¥åˆ†å¸ƒç›¸è¿‘ï¼Œå¹¶ä¸”åˆ†å¸ƒåœ¨è¾ƒå°èŒƒå›´å†…(å¦‚0é™„è¿‘)ï¼Œæ›´æœ‰åˆ©äºå‡½æ•°çš„ä¼˜åŒ–ã€‚
é‚£ä¹ˆå¦‚ä½•ä¿è¯è¾“å…¥xçš„åˆ†å¸ƒç›¸è¿‘å‘¢ï¼Ÿæ•°æ®æ ‡å‡†åŒ–å¯ä»¥å®ç°æ­¤ç›®çš„ï¼Œé€šè¿‡æ•°æ®æ ‡å‡†åŒ–æ“ä½œå¯ä»¥å°†æ•°æ®æ•°æ®ğ‘¥æ˜ å°„åˆ°ğ‘¥Ì‚:
                                ğ‘¥Ì‚ = ğ‘¥ âˆ’ ğœ‡ğ‘Ÿ / âˆšğœğ‘Ÿ2 + ğœ–
å…¶ä¸­ğœ‡ğ‘Ÿã€ğœğ‘Ÿ2æ¥è‡ªç»Ÿè®¡çš„æ‰€æœ‰æ•°æ®çš„å‡å€¼å’Œæ–¹å·®ï¼Œğœ–æ˜¯ä¸ºé˜²æ­¢å‡ºç°é™¤ 0 é”™è¯¯è€Œè®¾ç½®çš„è¾ƒå°æ•°å­—ï¼Œå¦‚ 1e âˆ’ 8ã€‚

åœ¨åŸºäº Batch çš„è®­ç»ƒé˜¶æ®µï¼Œå¦‚ä½•è·å–æ¯ä¸ªç½‘ç»œå±‚æ‰€æœ‰è¾“å…¥çš„ç»Ÿè®¡æ•°æ®ğœ‡ğ‘Ÿã€ğœğ‘Ÿ2å‘¢ï¼Ÿè€ƒè™‘Batch å†…éƒ¨çš„å‡å€¼ğœ‡ğµå’Œæ–¹å·®ğœğµ2ï¼š
                                    ğœ‡ğµ = 1 / ğ‘šâˆ‘ğ‘¥ğ‘–
                                ğœğµ2 = 1/ğ‘šâˆ‘(ğ‘¥ğ‘– âˆ’ ğœ‡ğµ)2
å¯ä»¥è§†ä¸ºè¿‘ä¼¼äºğœ‡ğ‘Ÿã€ğœğ‘Ÿ2ï¼Œå…¶ä¸­ğ‘šä¸º Batch æ ·æœ¬æ•°ã€‚å› æ­¤ï¼Œåœ¨è®­ç»ƒé˜¶æ®µï¼Œé€šè¿‡
                            ğ‘¥Ì‚train = ğ‘¥train âˆ’ ğœ‡ğµ /âˆš(ğœğµ2 + ğœ–)
æ ‡å‡†åŒ–è¾“å…¥ï¼Œå¹¶è®°å½•æ¯ä¸ª Batch çš„ç»Ÿè®¡æ•°æ®ğœ‡ğµã€ğœğµ2ï¼Œç”¨äºç»Ÿè®¡çœŸå®çš„å…¨å±€ğœ‡ğ‘Ÿã€ğœğ‘Ÿ2

åœ¨æµ‹è¯•é˜¶æ®µï¼Œæ ¹æ®è®°å½•çš„æ¯ä¸ª Batch çš„ğœ‡ğµã€ğœğµ2ä¼°è®¡å‡ºæ‰€æœ‰è®­ç»ƒæ•°æ®çš„ğœ‡ğ‘Ÿã€ğœğ‘Ÿ2ï¼ŒæŒ‰ç€
                                 ğ‘¥Ì‚test = ğ‘¥test âˆ’ ğœ‡r /âˆš(ğœr2 + ğœ–)
å°†æ¯å±‚çš„è¾“å…¥æ ‡å‡†åŒ–ã€‚

ä¸Šè¿°çš„æ ‡å‡†åŒ–è¿ç®—å¹¶æ²¡æœ‰å¼•å…¥é¢å¤–çš„å¾…ä¼˜åŒ–å˜é‡ï¼Œğœ‡ğ‘Ÿã€ğœğ‘Ÿ2å’Œğœ‡ğµã€ğœğµ2å‡ç”±ç»Ÿè®¡å¾—åˆ°ï¼Œä¸éœ€è¦å‚ä¸æ¢¯åº¦æ›´æ–°ã€‚
å®é™…ä¸Šï¼Œä¸ºäº†æé«˜BNå±‚çš„è¡¨è¾¾èƒ½åŠ›ï¼ŒBN å±‚ä½œè€…å¼•å…¥äº†â€œscale and shiftâ€æŠ€å·§ï¼Œå°†ğ‘¥Ì‚å˜é‡å†æ¬¡æ˜ å°„å˜æ¢ï¼š
                                  ğ‘¥Ìƒ = ğ‘¥Ì‚ âˆ™ ğ›¾ + ğ›½
å…¶ä¸­ğ›¾å‚æ•°å®ç°å¯¹æ ‡å‡†åŒ–åçš„ğ‘¥Ì‚å†æ¬¡è¿›è¡Œç¼©æ”¾ï¼Œğ›½å‚æ•°å®ç°å¯¹æ ‡å‡†åŒ–çš„ğ‘¥Ì‚è¿›è¡Œå¹³ç§»ï¼Œä¸åŒçš„æ˜¯ï¼Œğ›¾ã€ğ›½å‚æ•°å‡ç”±åå‘ä¼ æ’­ç®—æ³•è‡ªåŠ¨ä¼˜åŒ–ï¼Œ
å®ç°ç½‘ç»œå±‚â€œæŒ‰éœ€â€ç¼©æ”¾å¹³ç§»æ•°æ®çš„åˆ†å¸ƒçš„ç›®çš„ã€‚
ä¸‹é¢æˆ‘ä»¬æ¥å­¦ä¹ åœ¨ TensorFlow ä¸­å®ç°çš„ BN å±‚çš„æ–¹æ³•ã€‚


10.8.1å‰å‘ä¼ æ’­
æˆ‘ä»¬å°† BN å±‚çš„è¾“å…¥è®°ä¸ºğ‘¥ï¼Œè¾“å‡ºè®°ä¸ºğ‘¥Ìƒã€‚åˆ†è®­ç»ƒé˜¶æ®µå’Œæµ‹è¯•é˜¶æ®µæ¥è®¨è®ºå‰å‘ä¼ æ’­è¿‡ç¨‹ã€‚
è®­ç»ƒé˜¶æ®µï¼šé¦–å…ˆè®¡ç®—å½“å‰ Batch çš„ğœ‡ğµã€ğœğµ2ï¼Œæ ¹æ®
                        ğ‘¥Ìƒtrain = (ğ‘¥train âˆ’ ğœ‡ğµ) âˆš(ğœğµ2 + ğœ–) âˆ™ ğ›¾ + ğ›½
è®¡ç®—BNå±‚çš„è¾“å‡ºã€‚
åŒæ—¶æŒ‰ç…§
                        ğœ‡ğ‘Ÿ â† momentum âˆ™ ğœ‡ğ‘Ÿ + (1 âˆ’ momentum) âˆ™ ğœ‡ğµ
                        ğœğ‘Ÿ2 â† momentum âˆ™ ğœğ‘Ÿ2 + (1 âˆ’ momentum) âˆ™ ğœğµ2
è¿­ä»£æ›´æ–°å…¨å±€è®­ç»ƒæ•°æ®çš„ç»Ÿè®¡å€¼ğœ‡ğ‘Ÿå’Œğœğ‘Ÿ2ï¼Œå…¶ä¸­ momentum æ˜¯éœ€è¦è®¾ç½®ä¸€ä¸ªè¶…å‚æ•°ï¼Œç”¨äºå¹³è¡¡ğœ‡ğ‘Ÿã€ğœğ‘Ÿ2çš„æ›´æ–°å¹…åº¦ï¼š
å½“momentum = 0æ—¶ï¼Œğœ‡ğ‘Ÿå’Œğœğ‘Ÿ2ç›´æ¥è¢«è®¾ç½®ä¸ºæœ€æ–°ä¸€ä¸ª Batch çš„ğœ‡ğµ å’Œğœğµ2ï¼›
å½“momentum = 1æ—¶ï¼Œğœ‡ğ‘Ÿå’Œğœğ‘Ÿ2ä¿æŒä¸å˜ï¼Œå¿½ç•¥æœ€æ–°ä¸€ä¸ª Batch çš„ğœ‡ğµå’Œğœğµ2ï¼Œ
åœ¨TensorFlow ä¸­ï¼Œmomentum é»˜è®¤è®¾ç½®ä¸º 0.99ã€‚

æµ‹è¯•é˜¶æ®µï¼šBN å±‚æ ¹æ®
                        ğ‘¥Ìƒtest = (ğ‘¥test âˆ’ ğœ‡ğ‘Ÿ )âˆš(ğœğ‘Ÿ2 + ğœ–) âˆ— ğ›¾ + ğ›½
è®¡ç®—è¾“å‡ºğ‘¥Ìƒğ‘¡ğ‘’ğ‘ ğ‘¡ï¼Œå…¶ä¸­ğœ‡ğ‘Ÿã€ğœğ‘Ÿ2ã€ğ›¾ã€ğ›½å‡æ¥è‡ªè®­ç»ƒé˜¶æ®µç»Ÿè®¡æˆ–ä¼˜åŒ–çš„ç»“æœï¼Œåœ¨æµ‹è¯•é˜¶æ®µç›´æ¥ä½¿ç”¨ï¼Œå¹¶ä¸ä¼šæ›´æ–°è¿™äº›å‚æ•°ã€‚



10.8.2åå‘æ›´æ–°
åœ¨è®­ç»ƒæ¨¡å¼ä¸‹çš„åå‘æ›´æ–°é˜¶æ®µï¼Œåå‘ä¼ æ’­ç®—æ³•æ ¹æ®æŸå¤±â„’æ±‚è§£æ¢¯åº¦ğœ•â„’/ğœ•ğ›¾å’Œğœ•â„’/ğœ•ğ›½ï¼Œå¹¶æŒ‰ç€æ¢¯åº¦æ›´æ–°æ³•åˆ™è‡ªåŠ¨ä¼˜åŒ–ğ›¾ã€ğ›½å‚æ•°ã€‚

éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå¯¹äº 2D ç‰¹å¾å›¾è¾“å…¥ğ‘¿: [b â„ ğ‘¤ ğ‘] ï¼ŒBN å±‚å¹¶ä¸æ˜¯è®¡ç®—æ¯ä¸ªç‚¹çš„ğœ‡ğµã€ ğœğµ2ï¼Œè€Œæ˜¯åœ¨é€šé“è½´ğ‘ä¸Šé¢ç»Ÿè®¡æ¯ä¸ªé€šé“ä¸Šé¢æ‰€æœ‰æ•°æ®çš„ğœ‡ğµã€ğœğµ2ï¼Œ
å› æ­¤ğœ‡ğµã€ğœğµ2æ˜¯æ¯ä¸ªé€šé“ä¸Šæ‰€æœ‰å…¶å®ƒç»´åº¦çš„å‡å€¼å’Œæ–¹å·®ã€‚ä»¥ shape ä¸º [100 32 32 3 ]çš„è¾“å…¥ä¸ºä¾‹ï¼Œåœ¨é€šé“è½´ğ‘ä¸Šé¢çš„å‡å€¼è®¡ç®—å¦‚ä¸‹ï¼š
# æ„é€ è¾“å…¥
x=tf.random.normal([100,32,32,3])
# å°†å…¶ä»–ç»´åº¦åˆå¹¶ï¼Œä»…ä¿ç•™é€šé“ç»´åº¦
x=tf.reshape(x,[-1,3])
# è®¡ç®—å…¶ä»–ç»´åº¦çš„å‡å€¼
ub=tf.reduce_mean(x,axis=0)
ub
Out[7]: # é€šé“ç»´åº¦çš„å‡å€¼
<tf.Tensor: id=62, shape=(3,), dtype=float32, numpy=array([-0.00222636, -
0.00049868, -0.00180082], dtype=float32)>
æ•°æ®æœ‰ğ‘ä¸ªé€šé“æ•°ï¼Œåˆ™æœ‰ğ‘ä¸ªå‡å€¼äº§ç”Ÿã€‚

é™¤äº†åœ¨ğ‘è½´ä¸Šé¢ç»Ÿè®¡æ•°æ®ğœ‡ğµã€ğœğµ2çš„æ–¹å¼ï¼Œæˆ‘ä»¬ä¹Ÿå¾ˆå®¹æ˜“å°†å…¶æ¨å¹¿è‡³å…¶å®ƒç»´åº¦è®¡ç®—å‡å€¼çš„æ–¹å¼ï¼Œå¦‚å›¾ 10.41 æ‰€ç¤ºï¼š
â‘ Layer Normï¼šç»Ÿè®¡æ¯ä¸ªæ ·æœ¬çš„æ‰€æœ‰ç‰¹å¾çš„å‡å€¼å’Œæ–¹å·®
â‘ Instance Normï¼šç»Ÿè®¡æ¯ä¸ªæ ·æœ¬çš„æ¯ä¸ªé€šé“ä¸Šç‰¹å¾çš„å‡å€¼å’Œæ–¹å·®
â‘ Group Normï¼šå°†ğ‘é€šé“åˆ†æˆè‹¥å¹²ç»„ï¼Œç»Ÿè®¡æ¯ä¸ªæ ·æœ¬çš„é€šé“ç»„å†…çš„ç‰¹å¾å‡å€¼å’Œæ–¹å·®

ä¸Šé¢æåˆ°çš„ Normalization æ–¹æ³•å‡ç”±ç‹¬ç«‹çš„å‡ ç¯‡è®ºæ–‡æå‡ºï¼Œå¹¶åœ¨æŸäº›åº”ç”¨ä¸ŠéªŒè¯äº†å…¶ç›¸å½“æˆ–è€…ä¼˜äº BatchNorm ç®—æ³•çš„æ•ˆæœã€‚
ç”±æ­¤å¯è§ï¼Œæ·±åº¦å­¦ä¹ ç®—æ³•ç ”ç©¶å¹¶ééš¾äºä¸Šé’å¤©ï¼Œåªè¦å¤šæ€è€ƒã€å¤šé”»ç‚¼ç®—æ³•å·¥ç¨‹èƒ½åŠ›ï¼Œäººäººéƒ½æœ‰æœºä¼šå‘è¡¨åˆ›æ–°æ€§æˆæœã€‚



10.8.3BNå±‚å®ç°
åœ¨ TensorFlow ä¸­ï¼Œé€šè¿‡ layers.BatchNormalization()ç±»å¯ä»¥éå¸¸æ–¹ä¾¿åœ°å®ç° BN å±‚ï¼š
# åˆ›å»º BN å±‚
layer=layers.BatchNormalization()
ä¸å…¨è¿æ¥å±‚ã€å·ç§¯å±‚ä¸åŒï¼ŒBN å±‚çš„è®­ç»ƒé˜¶æ®µå’Œæµ‹è¯•é˜¶æ®µçš„è¡Œä¸ºä¸åŒï¼Œéœ€è¦é€šè¿‡è®¾ç½®training æ ‡å¿—ä½æ¥åŒºåˆ†è®­ç»ƒæ¨¡å¼è¿˜æ˜¯æµ‹è¯•æ¨¡å¼ã€‚

ä»¥ LeNet-5 çš„ç½‘ç»œæ¨¡å‹ä¸ºä¾‹ï¼Œåœ¨å·ç§¯å±‚åæ·»åŠ  BN å±‚ï¼Œä»£ç å¦‚ä¸‹ï¼š
network = Sequential([ # ç½‘ç»œå®¹å™¨
layers.Conv2D(6,kernel_size=3,strides=1),
# æ’å…¥ BN å±‚
layers.BatchNormalization(),
layers.MaxPooling2D(pool_size=2,strides=2),
layers.ReLU(),
layers.Conv2D(16,kernel_size=3,strides=1),
# æ’å…¥ BN å±‚
layers.BatchNormalization(),
layers.MaxPooling2D(pool_size=2,strides=2),
layers.ReLU(),
layers.Flatten(),
layers.Dense(120, activation='relu'),
# æ­¤å¤„ä¹Ÿå¯ä»¥æ’å…¥ BN å±‚
layers.Dense(84, activation='relu'),
# æ­¤å¤„ä¹Ÿå¯ä»¥æ’å…¥ BN å±‚
layers.Dense(10)])

åœ¨è®­ç»ƒé˜¶æ®µï¼Œéœ€è¦è®¾ç½®ç½‘ç»œçš„å‚æ•° training=True ä»¥åŒºåˆ† BN å±‚æ˜¯è®­ç»ƒè¿˜æ˜¯æµ‹è¯•æ¨¡å‹ï¼Œä»£ç å¦‚ä¸‹ï¼š
with tf.GradientTape() as tape:
    # æ’å…¥é€šé“ç»´åº¦
    x = tf.expand_dims(x,axis=3)
    # å‰å‘è®¡ç®—ï¼Œè®¾ç½®è®¡ç®—æ¨¡å¼ï¼Œ[b, 784] => [b, 10]
    out = network(x, training=True)
åœ¨æµ‹è¯•é˜¶æ®µï¼Œéœ€è¦è®¾ç½® training=Falseï¼Œé¿å… BN å±‚é‡‡ç”¨é”™è¯¯çš„è¡Œä¸ºï¼Œä»£ç å¦‚ä¸‹ï¼š
for x,y in db_test: # éå†æµ‹è¯•é›†
    # æ’å…¥é€šé“ç»´åº¦
    x = tf.expand_dims(x,axis=3) # å‰å‘è®¡ç®—ï¼Œæµ‹è¯•æ¨¡å¼
    out = network(x, training=False)
"""